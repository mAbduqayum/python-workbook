name: Sync to Solutions

on:
  push:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent runs for the same branch, canceling older runs.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # default

jobs:
  sync-solutions:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event.repository.fork == false
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for git operations

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync main branch to solutions branch
        run: |
          set -e # Exit on error
          set -x # Print commands

          # Check if the solutions branch exists on the remote
          if git show-ref --verify --quiet refs/remotes/origin/solutions; then
            echo "‚úÖ Solutions branch found on remote, syncing..."
            git checkout solutions

            # Try merge first
            if git merge origin/main; then
              echo "‚úÖ Merged latest changes from main"
            else
              echo "‚ö†Ô∏è Merge conflict detected, trying rebase..."
              git merge --abort

              if git rebase origin/main; then
                echo "‚úÖ Rebased on main successfully"
              else
                echo "‚ùå Rebase failed, manual intervention required"
                git rebase --abort
                exit 1
              fi
            fi
          else
            echo "üÜï Solutions branch not found on remote, creating..."
            # Create the solutions branch from the current state of main
            git checkout -b solutions
            echo "‚úÖ Created new solutions branch"
          fi

          # Push the changes to the solutions branch
          echo "üì§ Pushing updates to solutions branch..."
          git push origin solutions --force-with-lease
          echo "‚úÖ Solutions branch successfully updated"

      - name: Report sync status
        run: |
          echo "‚úÖ Questions successfully synced to solutions branch"
          echo "üìã Latest commits on solutions branch:"
          git log --oneline -5
